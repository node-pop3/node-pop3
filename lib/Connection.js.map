{"version":3,"file":"Connection.js","names":["value","then","direct","Promise","resolve","Pop3Connection","host","port","tls","timeout","tlsOptions","servername","_socket","_stream","_command","Readable","read","buffer","TERMINATOR_BUFFER_ARRAY","some","_buffer","equals","_endStream","endBuffer","slice","TERMINATOR_BUFFER","push","err","emit","socket","Socket","setKeepAlive","reject","setTimeout","Error","eventName","listeners","length","end","options","Object","assign","_tls","connect","on","_pushStream","crlfSliceEndIndex","CRLF_BUFFER","command","infoBuffer","split","commandName","stream","MULTI_LINE_COMMAND_NAME","includes","_updateStream","toString","once","args","join","rejectFn","info","removeListener","write","CRLF","EventEmitter"],"sources":["../src/Connection.mjs"],"sourcesContent":["import { Socket } from 'net';\r\nimport _tls from 'tls';\r\nimport { EventEmitter } from 'events';\r\nimport { Readable } from 'stream';\r\n\r\nimport {\r\n  CRLF,\r\n  CRLF_BUFFER,\r\n  TERMINATOR_BUFFER,\r\n  TERMINATOR_BUFFER_ARRAY,\r\n  MULTI_LINE_COMMAND_NAME\r\n} from './constant.mjs';\r\n\r\nclass Pop3Connection extends EventEmitter {\r\n  constructor({\r\n    host,\r\n    port,\r\n    tls,\r\n    timeout,\r\n    tlsOptions,\r\n    servername\r\n  }) {\r\n    super();\r\n    this.host = host;\r\n    this.port = port || (tls ? 995 : 110);\r\n    this.tls = tls;\r\n    this.timeout = timeout;\r\n    this._socket = null;\r\n    this._stream = null;\r\n    this._command;\r\n    this.tlsOptions = tlsOptions || {};\r\n    this.servername = servername || host;\r\n  }\r\n\r\n  _updateStream() {\r\n    this._stream = new Readable({\r\n      read: () => {},\r\n    });\r\n    return this._stream;\r\n  }\r\n\r\n  _pushStream(buffer) {\r\n    if (TERMINATOR_BUFFER_ARRAY.some((_buffer) => _buffer.equals(buffer))) {\r\n      return this._endStream();\r\n    }\r\n    const endBuffer = buffer.slice(-5);\r\n    if (endBuffer.equals(TERMINATOR_BUFFER)) {\r\n      this._stream.push(buffer.slice(0, -5));\r\n      return this._endStream();\r\n    }\r\n    this._stream.push(buffer);\r\n  }\r\n\r\n  _endStream(err) {\r\n    if (this._stream) {\r\n      this._stream.push(null);\r\n    }\r\n    this._stream = null;\r\n    this.emit('end', err);\r\n  }\r\n\r\n  connect() {\r\n    const { host, port, tlsOptions, servername } = this;\r\n    const socket = new Socket();\r\n    socket.setKeepAlive(true);\r\n    return new Promise((resolve, reject) => {\r\n      if (typeof this.timeout !== 'undefined') {\r\n        socket.setTimeout(this.timeout, () => {\r\n          const err = new Error('timeout');\r\n          err.eventName = 'timeout';\r\n          reject(err);\r\n          if (this.listeners('end').length) {\r\n            this.emit('end', err);\r\n          }\r\n          if (this.listeners('error').length) {\r\n            this.emit('error', err);\r\n          }\r\n          this._socket.end();\r\n          this._socket = null;\r\n        });\r\n      }\r\n      if (this.tls) {\r\n        const options = Object.assign({ host, port, socket, servername }, tlsOptions);\r\n        this._socket = _tls.connect(options);\r\n      } else {\r\n        this._socket = socket;\r\n      }\r\n\r\n      this._socket.on('data', (buffer) => {\r\n        if (this._stream) {\r\n          return this._pushStream(buffer);\r\n        }\r\n        \r\n        // only cut off crlf if it's existing in payload\r\n        const crlfSliceEndIndex = buffer.slice(buffer.length - 2).equals(CRLF_BUFFER)\r\n          ? -2\r\n          : buffer.length;\r\n\r\n        if (buffer[0] === 45) { // '-'\r\n          const err = new Error(buffer.slice(5, crlfSliceEndIndex));\r\n          err.eventName = 'error';\r\n          err.command = this._command;\r\n          return this.emit('error', err);\r\n        }\r\n        if (buffer[0] === 43) { // '+'\r\n          const infoBuffer = buffer.slice(4, crlfSliceEndIndex);\r\n          const [commandName] = (this._command || '').split(' ');\r\n          let stream = null;\r\n          if (MULTI_LINE_COMMAND_NAME.includes(commandName)) {\r\n            this._updateStream();\r\n            stream = this._stream;\r\n          }\r\n          this.emit('response', infoBuffer.toString(), stream);\r\n          resolve();\r\n          return;\r\n        }\r\n        const err = new Error('Unexpected response');\r\n        err.eventName = 'bad-server-response';\r\n        reject(err);\r\n      });\r\n      this._socket.on('error', (err) => {\r\n        err.eventName = 'error';\r\n        if (this._stream) {\r\n          this.emit('error', err);\r\n          return;\r\n        }\r\n        reject(err);\r\n        this._socket = null;\r\n      });\r\n      this._socket.once('close', () => {\r\n        const err = new Error('close');\r\n        err.eventName = 'close';\r\n        reject(err);\r\n        this._socket = null;\r\n      });\r\n      this._socket.once('end', () => {\r\n        const err = new Error('end');\r\n        err.eventName = 'end';\r\n        reject(err);\r\n        this._socket = null;\r\n      });\r\n      socket.connect({\r\n        host,\r\n        port,\r\n      });\r\n    });\r\n  }\r\n\r\n  async command(...args) {\r\n    this._command = args.join(' ');\r\n    if (!this._socket) {\r\n      throw new Error('no-socket');\r\n    }\r\n    await new Promise((resolve, reject) => {\r\n      if (!this._stream) {\r\n        return resolve();\r\n      }\r\n      this.once('error', (err) => {\r\n        return reject(err);\r\n      });\r\n      this.once('end', (err) => {\r\n        return err ? reject(err) : resolve();\r\n      });\r\n    });\r\n    return new Promise((resolve, reject) => {\r\n      const rejectFn = (err) => reject(err);\r\n      this.once('error', rejectFn);\r\n      this.once('response', (info, stream) => {\r\n        this.removeListener('error', rejectFn);\r\n        resolve([info, stream]);\r\n      });\r\n      if (!this._socket) {\r\n        reject(new Error('no-socket'));\r\n      }\r\n      this._socket.write(`${this._command}${CRLF}`, 'utf8');\r\n    });\r\n  }\r\n}\r\n\r\nexport default Pop3Connection;\r\n"],"mappings":"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"}