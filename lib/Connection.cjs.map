{"version":3,"file":"Connection.cjs","names":["Pop3Connection","EventEmitter","constructor","host","port","tls","timeout","tlsOptions","servername","_socket","_stream","_command","_updateStream","Readable","read","_pushStream","buffer","TERMINATOR_BUFFER_ARRAY","some","_buffer","equals","_endStream","endBuffer","slice","TERMINATOR_BUFFER","push","err","emit","connect","socket","Socket","setKeepAlive","Promise","resolve","reject","setTimeout","Error","eventName","listeners","length","end","options","Object","assign","_tls","on","command","firstLineEndIndex","indexOf","CRLF_BUFFER","infoBuffer","commandName","msgNumber","split","stream","MULTI_LINE_COMMAND_NAME","includes","MAYBE_MULTI_LINE_COMMAND_NAME","bodyBuffer","toString","once","args","join","rejectFn","info","removeListener","write","CRLF"],"sources":["../src/Connection.js"],"sourcesContent":["import { Socket } from 'net';\nimport _tls from 'tls';\nimport { EventEmitter } from 'events';\nimport { Readable } from 'stream';\n\nimport {\n  CRLF,\n  CRLF_BUFFER,\n  TERMINATOR_BUFFER,\n  TERMINATOR_BUFFER_ARRAY,\n  MULTI_LINE_COMMAND_NAME,\n  MAYBE_MULTI_LINE_COMMAND_NAME\n} from './constant.js';\n\nclass Pop3Connection extends EventEmitter {\n  constructor({\n    host,\n    port,\n    tls,\n    timeout,\n    tlsOptions,\n    servername\n  }) {\n    super();\n    this.host = host;\n    this.port = port || (tls ? 995 : 110);\n    this.tls = tls;\n    this.timeout = timeout;\n    this._socket = null;\n    this._stream = null;\n    this._command;\n    this.tlsOptions = tlsOptions || {};\n    this.servername = servername || host;\n  }\n\n  _updateStream() {\n    this._stream = new Readable({\n      read: () => {},\n    });\n    return this._stream;\n  }\n\n  _pushStream(buffer) {\n    if (TERMINATOR_BUFFER_ARRAY.some((_buffer) => _buffer.equals(buffer))) {\n      return this._endStream();\n    }\n    const endBuffer = buffer.slice(-5);\n    if (endBuffer.equals(TERMINATOR_BUFFER)) {\n      this._stream.push(buffer.slice(0, -5));\n      return this._endStream();\n    }\n    this._stream.push(buffer);\n  }\n\n  _endStream(err) {\n    if (this._stream) {\n      this._stream.push(null);\n    }\n    this._stream = null;\n    this.emit('end', err);\n  }\n\n  connect() {\n    const { host, port, tlsOptions, servername } = this;\n    const socket = new Socket();\n    socket.setKeepAlive(true);\n    return new Promise((resolve, reject) => {\n      if (typeof this.timeout !== 'undefined') {\n        socket.setTimeout(this.timeout, () => {\n          const err = new Error('timeout');\n          err.eventName = 'timeout';\n          reject(err);\n          if (this.listeners('end').length) {\n            this.emit('end', err);\n          }\n          if (this.listeners('error').length) {\n            this.emit('error', err);\n          }\n          this._socket.end();\n          this._socket = null;\n        });\n      }\n      if (this.tls) {\n        const options = Object.assign({ host, port, socket, servername }, tlsOptions);\n        this._socket = _tls.connect(options);\n      } else {\n        this._socket = socket;\n      }\n\n      this._socket.on('data', (buffer) => {\n        if (this._stream) {\n          return this._pushStream(buffer);\n        }\n        if (buffer[0] === 45) { // '-'\n          const err = new Error(buffer.slice(5, -2));\n          err.eventName = 'error';\n          err.command = this._command;\n          return this.emit('error', err);\n        }\n        if (buffer[0] === 43) { // '+'\n          const firstLineEndIndex = buffer.indexOf(CRLF_BUFFER);\n          const infoBuffer = buffer.slice(4, firstLineEndIndex);\n          const [commandName, msgNumber] = (this._command || '').split(' ');\n          let stream = null;\n          if (MULTI_LINE_COMMAND_NAME.includes(commandName) ||\n              !msgNumber && MAYBE_MULTI_LINE_COMMAND_NAME.includes(commandName)) {\n            this._updateStream();\n            stream = this._stream;\n            const bodyBuffer = buffer.slice(firstLineEndIndex + 2);\n            if (bodyBuffer[0]) {\n              this._pushStream(bodyBuffer);\n            }\n          }\n          this.emit('response', infoBuffer.toString(), stream);\n          resolve();\n          return;\n        }\n        const err = new Error('Unexpected response');\n        err.eventName = 'bad-server-response';\n        reject(err);\n      });\n      this._socket.on('error', (err) => {\n        err.eventName = 'error';\n        if (this._stream) {\n          this.emit('error', err);\n          return;\n        }\n        reject(err);\n        this._socket = null;\n      });\n      this._socket.once('close', () => {\n        const err = new Error('close');\n        err.eventName = 'close';\n        reject(err);\n        this._socket = null;\n      });\n      this._socket.once('end', () => {\n        const err = new Error('end');\n        err.eventName = 'end';\n        reject(err);\n        this._socket = null;\n      });\n      socket.connect({\n        host,\n        port,\n      });\n    });\n  }\n\n  async command(...args) {\n    this._command = args.join(' ');\n    if (!this._socket) {\n      throw new Error('no-socket');\n    }\n    await new Promise((resolve, reject) => {\n      if (!this._stream) {\n        return resolve();\n      }\n      this.once('error', (err) => {\n        return reject(err);\n      });\n      this.once('end', (err) => {\n        return err ? reject(err) : resolve();\n      });\n    });\n    return new Promise((resolve, reject) => {\n      const rejectFn = (err) => reject(err);\n      this.once('error', rejectFn);\n      this.once('response', (info, stream) => {\n        this.removeListener('error', rejectFn);\n        resolve([info, stream]);\n      });\n      if (!this._socket) {\n        reject(new Error('no-socket'));\n      }\n      this._socket.write(`${this._command}${CRLF}`, 'utf8');\n    });\n  }\n}\n\nexport default Pop3Connection;\n"],"mappings":"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"}